<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ğŸ”‹ æ–°èƒ½æºåŸºé‡‘æ“ä½œå»ºè®®ï¼ˆçœŸå®å¯ç”¨ç‰ˆï¼‰</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; padding: 20px; background: #f9fafb; }
    .container { max-width: 800px; margin: 0 auto; }
    h1 { text-align: center; color: #0d6efd; margin-bottom: 24px; }
    .data-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; }
    .label { color: #4a5568; }
    .value { font-weight: bold; color: #1a73e8; }
    .error { color: #e53e3e; }
    #advice { margin-top: 24px; padding: 16px; background: #fff8e1; border-left: 4px solid #ffc107; }
    #update-time { text-align: center; margin-top: 24px; color: #718096; font-size: 0.9em; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ”‹ æ–°èƒ½æºåŸºé‡‘æ“ä½œå»ºè®®ï¼ˆè‡ªåŠ¨çœŸå®æ•°æ®ç‰ˆï¼‰</h1>
    
    <div id="data-panel">
      <div class="data-row">
        <span class="label">åŸºé‡‘ï¼ˆ001158ï¼‰å‡€å€¼ï¼š</span>
        <span class="value" id="fund-value">â€”</span>
      </div>
      <div class="data-row">
        <span class="label">åˆ›ä¸šæ¿æŒ‡ï¼ˆ399006ï¼‰ï¼š</span>
        <span class="value" id="cyb-value">â€”</span>
      </div>
      <div class="data-row">
        <span class="label">æ–°èƒ½æºæŒ‡æ•°ï¼ˆ399808ï¼‰ï¼š</span>
        <span class="value" id="ne-value">â€”</span>
      </div>
      <div class="data-row">
        <span class="label">æˆäº¤é¢ï¼ˆäº¿å…ƒï¼‰ï¼š</span>
        <span class="value" id="volume-value">â€”</span>
      </div>
    </div>

    <div id="advice">ç­‰å¾…æ•°æ®åŠ è½½...</div>
    <div id="update-time">æœ€è¿‘æ›´æ–°ï¼šâ€”</div>
  </div>

  <script>
    let fund = null, cyb = null, ne = null, volume = null;

    function updateUI() {
      const el = (id, text) => document.getElementById(id).textContent = text;
      
      el('fund-value', fund ? fund.toFixed(4) : 'â€”');
      el('cyb-value', cyb ? Math.round(cyb) : 'â€”');
      el('ne-value', ne ? Math.round(ne) : 'â€”');
      el('volume-value', volume ? (volume / 1e8).toFixed(0) : 'â€”');

      const allLoaded = fund !== null && cyb !== null && ne !== null && volume !== null;
      if (!allLoaded) {
        el('advice', 'âŒ æ— æ³•ç”Ÿæˆå»ºè®®ï¼šæ•°æ®ç¼ºå¤±');
        return;
      }

      // ç®€å•ç­–ç•¥
      let advice = "ğŸŸ¡ æŒæœ‰è§‚æœ›";
      if (ne > 4800 && volume > 800) {
        advice = "ğŸ”´ é«˜ä½æ”¾é‡ï¼Œå»ºè®®å‡ä»“";
      } else if (ne < 4000 && fund < 2.0) {
        advice = "ğŸŸ¢ ä½ä½åŒºåŸŸï¼Œå¯è€ƒè™‘å®šæŠ•";
      }
      el('advice', advice);

      const now = new Date();
      el('update-time', `æœ€è¿‘æ›´æ–°ï¼š${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`);
    }

    // 1. åŸºé‡‘å‡€å€¼ï¼ˆå¤©å¤©åŸºé‡‘ï¼ŒJSONPï¼‰
    const fundScript = document.createElement('script');
    fundScript.src = `https://fundgz.1234567.com.cn/js/001158.js?_=${Date.now()}`;
    window.jsonpgz = (data) => {
      fund = data?.dwjz ? parseFloat(data.dwjz) : null;
      updateUI();
    };
    fundScript.onerror = () => { fund = null; updateUI(); };
    document.head.appendChild(fundScript);

    // 2. é€šè¿‡ CORS ä»£ç†è·å–æŒ‡æ•°æ•°æ®
    async function fetchViaProxy(symbol, callback) {
      try {
        const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(`https://hq.sinajs.cn/list=${symbol}`)}`;
        const response = await fetch(proxyUrl);
        const text = await response.text();
        // è§£æï¼švar hq_str_xxx="åç§°,å½“å‰ä»·,..."
        const match = text.match(/"([^"]+)"/);
        if (match) {
          const parts = match[1].split(',');
          callback(parts);
        } else {
          callback(null);
        }
      } catch (e) {
        console.error(`Failed to load ${symbol}:`, e);
        callback(null);
      }
    }

    // åŠ è½½åˆ›ä¸šæ¿
    fetchViaProxy('sz399006', (parts) => {
      cyb = parts && parts.length > 1 ? parseFloat(parts[1]) : null;
      updateUI();
    });

    // åŠ è½½æ–°èƒ½æº
    fetchViaProxy('sz399808', (parts) => {
      if (parts && parts.length > 8) {
        ne = parseFloat(parts[1]);
        volume = parseFloat(parts[8]); // æˆäº¤é¢ï¼ˆå…ƒï¼‰
      } else {
        ne = null;
        volume = null;
      }
      updateUI();
    });
  </script>
</body>
</html>
